<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>محسّن الصور — اكتشاف الكلمة المفتاحية تلقائيًا</title>
  <style>
    body{font-family:system-ui,Arial;background:#f7f9fc;margin:0;padding:20px;direction:rtl}
    h1{color:#0078d7;font-size:20px;margin-bottom:12px}
    .box{background:#fff;padding:14px;border-radius:10px;max-width:820px;margin:auto;
         box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    label{display:block;margin-bottom:8px;font-size:13px;color:#333}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input[type="text"], input[type="number"], select, input[type="file"]{
      padding:8px;border:1px solid #ddd;border-radius:8px;width:100%}
    .col{flex:1;min-width:160px}
    button{padding:10px 14px;border:0;background:#0078d7;color:#fff;border-radius:8px;cursor:pointer}
    .small{padding:8px 10px;border-radius:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:16px}
    .item{background:#fff;padding:8px;border-radius:8px;border:1px solid #eee;text-align:center}
    .item img{width:100%;height:100px;object-fit:cover;border-radius:6px}
    .meta{font-size:12px;color:#555;margin-top:6px}
    #status{margin-top:10px;font-size:13px;color:#555}
    .checkbox{display:flex;align-items:center;gap:8px}
    @media(max-width:640px){ .row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="box">
    <h1>محسّن الصور — تنزيل فردي مع اكتشاف الكلمة المفتاحية</h1>

    <label>اختر الصور
      <input id="files" type="file" accept="image/*" multiple>
    </label>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>الكلمة المفتاحية (يمكن تركها فارغة لاكتشاف تلقائي)
          <input id="keyword" type="text" placeholder="مثال: سيارة تويوتا">
        </label>
      </div>
      <div class="col">
        <label>الموقع (اختياري)
          <input id="location" type="text" placeholder="مثال: الخرطوم">
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>عرض الصورة بعد التحسين (px)
          <select id="width"><option value="320">320</option><option value="400">400</option><option value="640" selected>640</option></select>
        </label>
      </div>
      <div class="col">
        <label>الجودة (٪)
          <input id="quality" type="number" min="50" max="85" value="78">
        </label>
      </div>
      <div class="col">
        <label>الصيغة
          <select id="format"><option value="webp">WebP</option><option value="jpeg">JPEG</option></select>
        </label>
      </div>
    </div>

    <div style="margin-top:8px;display:flex;gap:10px;align-items:center">
      <div class="checkbox">
        <input id="autodetect" type="checkbox" checked>
        <label for="autodetect" style="margin:0">تمكين الاكتشاف التلقائي من اسم الملف</label>
      </div>
      <button id="process" style="margin-left:auto">ابدأ التحسين والتنزيل</button>
      <button id="clear" class="small" style="background:#f3f4f6;color:#111">مسح</button>
    </div>

    <div id="status">جاهز — اختر صوراً ثم اضغط ابدأ.</div>

    <div id="result" class="grid"></div>
    <div style="margin-top:10px;font-size:12px;color:#666">
      ملاحظة: إذا كتبت كلمة مفتاحية يدوياً فإنها تغلب على الاكتشاف التلقائي.
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
(() => {
  const filesEl = document.getElementById('files');
  const keywordEl = document.getElementById('keyword');
  const locationEl = document.getElementById('location');
  const widthEl = document.getElementById('width');
  const qualityEl = document.getElementById('quality');
  const formatEl = document.getElementById('format');
  const autodetectEl = document.getElementById('autodetect');
  const processBtn = document.getElementById('process');
  const clearBtn = document.getElementById('clear');
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');

  // small stoplist/junk tokens to ignore
  const STOP = new Set(['img','image','photo','dsc','copy','scan','edited','2020','2021','2022','2023','2024','2025']);

  function human(n){ if(n<1024) return n + ' B'; if(n<1024*1024) return (n/1024).toFixed(1) + ' KB'; return (n/1024/1024).toFixed(2) + ' MB'; }

  // sanitize for filenames (allow Arabic + latin + numbers and hyphen/underscore)
  function sanitizeName(s){
    return String(s).toLowerCase()
      .replace(/[^\w\u0600-\u06FF\-]+/g,'-') // keep arabic, latin, digits, underscore, hyphen
      .replace(/^\-+|\-+$/g,'')
      .replace(/\-+/g,'-');
  }

  // auto-detect keyword from filename (heuristic)
  function detectKeywordFromFilename(filename){
    // remove extension and common camera prefixes
    const base = filename.replace(/\.[^.]+$/, '')
                         .replace(/^IMG_?/i,'').replace(/^DSC_?/i,'').replace(/^PXL_?/i,'');
    // split by non-alnum (but keep Arabic letters)
    const tokens = base.split(/[^0-9A-Za-z\u0600-\u06FF]+/u).filter(Boolean);
    // filter candidates: remove short tokens, numeric tokens, stopwords
    const candidates = tokens
      .map(t => t.trim())
      .filter(t => t.length >= 3 && !/^\d+$/.test(t))
      .filter(t => !STOP.has(t.toLowerCase()));
    if(candidates.length === 0){
      // fallback: pick any token length >=2
      const alt = tokens.filter(t => t.length >= 2);
      if(alt.length) return alt.slice(0,2).join(' ');
      return base.slice(0,20).replace(/[_\-\s]+/g,' ');
    }
    // score tokens: prefer longer tokens and those containing letters (Arabic or Latin)
    const scored = candidates.map(t => {
      const len = t.length;
      const hasArabic = /[\u0600-\u06FF]/.test(t) ? 1 : 0;
      const score = len * (hasArabic ? 1.15 : 1.0);
      return {t,score,len,hasArabic};
    }).sort((a,b) => b.score - a.score);
    // take top 1 or top 2 if they are both meaningful
    const top = scored.map(s => s.t);
    if(top.length >= 2 && top[1].length >= 3) return (top[0] + ' ' + top[1]).trim();
    return top[0];
  }

  function fileToImage(file){
    return new Promise((res,rej)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
      img.onerror = e => { URL.revokeObjectURL(url); rej(e); };
      img.src = url;
    });
  }

  function resizeToBlob(img, w, fmt, q){
    return new Promise(res => {
      const aspect = img.naturalHeight / img.naturalWidth;
      const W = Math.min(w, img.naturalWidth);
      const H = Math.round(W * aspect);
      const c = document.createElement('canvas');
      c.width = W; c.height = H;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, W, H);
      const mime = fmt === 'webp' ? 'image/webp' : 'image/jpeg';
      c.toBlob(blob => res(blob), mime, q);
    });
  }

  async function process(){
    const files = filesEl.files;
    if(!files || files.length === 0){ alert('اختر صوراً'); return; }
    processBtn.disabled = true; clearBtn.disabled = true;
    resultEl.innerHTML = ''; statusEl.textContent = 'جارٍ المعالجة...';

    const w = parseInt(widthEl.value,10);
    const q = Math.max(0.5, Math.min(0.85, (parseInt(qualityEl.value,10)||78)/100));
    const fmt = formatEl.value;
    const auto = autodetectEl.checked;

    for(let i=0;i<files.length;i++){
      const f = files[i];
      try {
        const img = await fileToImage(f);
        // determine keyword: manual first, otherwise autodetect
        const manualKw = (keywordEl.value || '').trim();
        let kw = manualKw;
        if(!manualKw && auto){
          kw = detectKeywordFromFilename(f.name);
        }
        kw = kw ? sanitizeName(kw) : null;
        const loc = (locationEl.value || '').trim();
        const locSan = loc ? sanitizeName(loc) : null;

        // filename parts
        const parts = [];
        if(kw) parts.push(kw);
        if(locSan) parts.push(locSan);
        if(parts.length === 0){
          // fallback to filename base
          parts.push(sanitizeName(f.name.replace(/\.[^.]+$/,'')));
        }
        // ensure unique index
        parts.push(String(i+1));
        const outName = parts.join('-') + (fmt === 'webp' ? '.webp' : '.jpg');

        // resize & blob
        const blob = await resizeToBlob(img, w, fmt, q);

        // preview & immediate download
        const url = URL.createObjectURL(blob);
        const card = document.createElement('div'); card.className = 'item';
        card.innerHTML = `<img src="${url}" alt="${outName}"><div class="meta">${outName}<div style="color:#777;font-size:11px">${human(blob.size)}</div></div>`;
        resultEl.appendChild(card);

        // trigger download (FileSaver)
        saveAs(blob, outName);

        // short delay to avoid browser blocking with many immediate downloads
        await new Promise(r => setTimeout(r,120));
        statusEl.textContent = `معالجة ${i+1} من ${files.length}`;
      } catch(e){
        console.error('error processing', f.name, e);
      }
    }

    statusEl.textContent = 'انتهت المعالجة — تفقد مجلد التنزيلات.';
    processBtn.disabled = false; clearBtn.disabled = false;
  }

  processBtn.addEventListener('click', process);
  clearBtn.addEventListener('click', ()=>{ filesEl.value = ''; resultEl.innerHTML = ''; statusEl.textContent = 'جاهز — اختر صوراً ثم اضغط ابدأ.'; });

})();
</script>
</body>
</html>
